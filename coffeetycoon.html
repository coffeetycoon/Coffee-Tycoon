<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Coffee Tycoon ☕</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  body { margin:0; font-family:"Nunito",sans-serif; background:#1e1e1e; color:#f5f5f5; }
  header { padding:16px; text-align:center; background:#2d2d2d; color:#fff; }
  header h2, header h3 { margin:4px 0; }

  main { display:flex; flex-wrap:wrap; padding:16px; gap:16px; }
  .card { background:#2b2b2b; border-radius:16px; box-shadow:0 2px 6px rgba(0,0,0,0.6); flex:1; min-width:280px; display:flex; flex-direction:column; max-height:600px; }
  .card h2 { margin:0; padding:12px 16px; background:#333; border-radius:16px 16px 0 0; font-size:1.1rem; color:#fff; }
  .content { padding:16px; flex:1; display:flex; flex-direction:column; justify-content:flex-start; align-items:center; overflow:auto; width:100%; box-sizing:border-box; }
  canvas#game { width:90%; height:100%; max-height:400px; background:#111; border:2px solid #444; border-radius:12px; cursor:pointer; padding:20px; }

  /* Shop upgrades */
  #upgrades { width:100%; box-sizing:border-box; }
  .upgrade {
    display:flex;
    align-items:center;
    background:#3a3a3a;
    padding:6px 10px;
    border-radius:8px;
    margin-bottom:6px;
    width:100%;
    min-height:40px;
    position:relative;
    box-sizing:border-box;
  }
  .upgrade span {
    flex:1 1 auto;
    min-width:0;
    margin-right:6px;
    font-size:0.85rem;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .upgrade button {
    position:absolute;
    right:10px;
    top:50%;
    transform:translateY(-50%);
    flex:none;
    font-size:0.8rem;
    padding:6px 12px;
    background:#444;
    color:#f5f5f5;
    border:none;
    border-radius:8px;
    cursor:pointer;
    transition:background 0.2s, transform 0.1s;
    box-shadow:0 2px 4px rgba(0,0,0,0.4);
  }
  .upgrade button:hover { background:#555; }
  .upgrade button:active { background:#666; transform:translateY(-50%) scale(0.95); }

  /* Upgrade counts */
  #upgradeCounts { margin-top:12px; width:100%; box-sizing:border-box; }
  #upgradeCounts div {
    display:flex;
    justify-content:space-between;
    font-size:0.85rem;
    width:100%;
    box-sizing:border-box;
  }

  /* Achievements */
  #achievements {
    margin-top:16px;
    background:#333;
    border-radius:8px;
    width:100%;
    padding:8px;
    flex-direction:column;
    overflow-y:auto;
    max-height:250px;
  }
  #achievements h3 { margin:0 0 8px 0; font-size:1rem; text-align:center; color:#fff; }
  #achievements ul { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:6px; }
  #achievements li {
    background:#2b2b2b;
    padding:6px 8px;
    border-radius:6px;
    color:#fff;
    font-size:0.9rem;
    cursor:default;
    position:relative;
  }
  /* removed pseudo-element tooltip because it was clipped by scroll container.
     We'll use a JS-attached tooltip element instead (below). */

  .progress { height:8px; background:#555; border-radius:4px; overflow:hidden; margin-top:4px; }
  .progress-bar { height:100%; background:#d2691e; width:0%; transition:width 0.3s; }

  /* Footer buttons dark */
  .footer button {
    background:#444;
    color:#f5f5f5;
    border:none;
    padding:6px 12px;
    border-radius:8px;
    cursor:pointer;
    transition:background 0.2s, transform 0.1s;
    box-shadow:0 2px 4px rgba(0,0,0,0.4);
  }
  .footer button:hover { background:#555; }
  .footer button:active { background:#666; transform:scale(0.95); }

  /* Tooltip element (JS injected) */
  .achievement-tooltip {
    position:fixed;
    background: rgba(20,20,20,0.95);
    color: #fff;
    padding:6px 8px;
    border-radius:6px;
    font-size:0.85rem;
    z-index:9999;
    pointer-events:none;
    white-space:nowrap;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    opacity:0;
    transform: translateY(0);
    transition: opacity 0.12s ease, transform 0.12s ease;
  }
  .achievement-tooltip.visible { opacity:1; }
</style>
</head>
<body>
<header>
  <h1>Coffee Tycoon ☕</h1>
  <p>Brew coffee, buy upgrades, grow your empire!</p>
  <h2 id="coffeeCount">Coffees: 0</h2>
  <h3 id="cpsCount">Coffees per Second: 0</h3>
</header>

<main>
  <section class="card left">
    <h2>Shop Upgrades</h2>
    <div class="content" id="shopContent" style="align-items:flex-start;">
      <div id="upgrades" class="shoplist"></div>
      <div id="upgradeCounts"></div>
    </div>
  </section>

  <section class="card center">
    <h2>Tap to Brew — Click the Cup!</h2>
    <div class="content" style="padding:0; height:100%; display:flex; justify-content:center; align-items:center;">
      <canvas id="game"></canvas>
    </div>
  </section>

  <section class="card right">
    <h2>Achievements</h2>
    <div class="content" id="achievements">
      <ul id="achievementList"></ul>
    </div>
  </section>
</main>

<div class="footer" style="background:#2d2d2d; padding:8px 16px; display:flex; justify-content:flex-end; align-items:center; flex-wrap:wrap; color:#ddd;">
  <div class="toolbar" style="display:flex; gap:8px; align-items:center;">
    <button id="saveBtn">Save</button>
    <button id="loadBtn">Load</button>
    <button id="resetBtn">Reset</button>
  </div>
</div>

<script>
/* ---------- canvas + core data ---------- */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

function sizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;
}
sizeCanvas();
window.addEventListener('resize', sizeCanvas);

let coffees = 0;
let clickPower = 1;
let cps = 0;
const particles = [];

const upgrades = [
  {name:"Auto Brewer", cost:50, cps:1, count:0},
  {name:"Barista", cost:150, cps:2, count:0},
  {name:"Robot Barista", cost:500, cps:5, count:0},
  {name:"New Shop", cost:2000, cps:10, count:0}
];

let cupScale = 1;
let cupBouncing = false;

/* achievements include requirement text for tooltip */
const achievements = [
  {name:"First Coffee", requirement:"Brew 1 coffee", condition:()=>coffees>=1, earned:false, progress:()=>coffees+"/1", percent:()=>Math.min((coffees/1)*100,100)},
  {name:"Coffee Lover", requirement:"Brew 100 coffees", condition:()=>coffees>=100, earned:false, progress:()=>coffees+"/100", percent:()=>Math.min((coffees/100)*100,100)},
  {name:"Barista Manager", requirement:"Own 1 Barista", condition:()=>upgrades.find(u=>u.name==="Barista").count>=1, earned:false, progress:()=>upgrades.find(u=>u.name==="Barista").count+"/1", percent:()=>Math.min((upgrades.find(u=>u.name==="Barista").count/1)*100,100)},
  {name:"Robot Overlord", requirement:"Own 1 Robot Barista", condition:()=>upgrades.find(u=>u.name==="Robot Barista").count>=1, earned:false, progress:()=>upgrades.find(u=>u.name==="Robot Barista").count+"/1", percent:()=>Math.min((upgrades.find(u=>u.name==="Robot Barista").count/1)*100,100)}
];

/* ---------- drawing ---------- */
function drawCup(){
  const centerX = canvas.width/2;
  const centerY = canvas.height/2 + 20;
  ctx.save();
  ctx.translate(centerX, centerY);
  ctx.scale(cupScale, cupScale);

  // cup
  ctx.fillStyle = "#fff";
  ctx.beginPath();
  ctx.moveTo(-25,-50); ctx.lineTo(25,-50); ctx.lineTo(20,50); ctx.lineTo(-20,50); ctx.closePath(); ctx.fill();
  // sleeve
  ctx.fillStyle = "#6f4e37";
  ctx.fillRect(-15,-10,30,20);
  // lid
  ctx.fillStyle = "#ccc";
  ctx.beginPath();
  ctx.ellipse(0,-50,27,8,0,0,2*Math.PI);
  ctx.fill();

  ctx.restore();
}

function addParticle(x,y,text="+1"){ particles.push({x,y,alpha:1,dy:-1,text}); }
function drawParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    ctx.globalAlpha = p.alpha;
    ctx.fillStyle = "#6f4e37";
    ctx.font = "20px Nunito";
    ctx.fillText(p.text, p.x, p.y);
    ctx.globalAlpha = 1;
    p.y += p.dy;
    p.alpha -= 0.02;
    if(p.alpha <= 0) particles.splice(i,1);
  }
}

function gameLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawCup();
  drawParticles();
  requestAnimationFrame(gameLoop);
  checkAchievements();
}
canvas.addEventListener('click', e => {
  // compute offsetX/offsetY relative to canvas
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  coffees += clickPower;
  addParticle(x, y, "+"+clickPower);
  bounceCup();
  updateUI();
});

/* ---------- cup bounce ---------- */
function bounceCup(){
  if(cupBouncing) return;
  cupBouncing = true;
  let scale = 1;
  let up = true;
  const interval = setInterval(()=>{
    if(up){
      scale += 0.05;
      if(scale >= 1.2) up = false;
    } else {
      scale -= 0.05;
      if(scale <= 1){
        scale = 1; cupBouncing = false; clearInterval(interval);
      }
    }
    cupScale = scale;
  }, 16);
}

/* ---------- UI updates ---------- */
function updateUI(){
  document.getElementById('coffeeCount').textContent = "Coffees: " + coffees;
  document.getElementById('cpsCount').textContent = "Coffees per Second: " + cps;
  updateUpgradeCounts();
}

/* ---------- upgrades rendering ---------- */
function renderUpgrades(){
  const container = document.getElementById('upgrades');
  container.innerHTML = "";
  upgrades.forEach(u=>{
    const row = document.createElement('div');
    row.className = 'upgrade';

    const text = document.createElement('span');
    text.textContent = `${u.name} (+${u.cps}/s) — ${u.cost} ☕`;
    text.title = `${u.name}\nCPS: ${u.cps}\nOwned: ${u.count}\nCurrent Cost: ${u.cost} ☕`;

    const btn = document.createElement('button');
    btn.textContent = 'Buy';
    btn.title = `Buy ${u.name} for ${u.cost} ☕ (+${u.cps}/s)`;
    btn.onclick = ()=>{
      if(coffees >= u.cost){
        coffees -= u.cost;
        cps += u.cps;
        u.count++;
        u.cost = Math.floor(u.cost * 1.5);
        addLog("Bought " + u.name);
        updateUI();
        renderUpgrades();
      } else {
        addLog("Not enough coffee for " + u.name);
      }
    };

    row.appendChild(text);
    row.appendChild(btn);
    container.appendChild(row);
  });
}

function updateUpgradeCounts(){
  const container = document.getElementById('upgradeCounts');
  container.innerHTML = "";
  upgrades.forEach(u=>{
    const div = document.createElement('div');
    div.innerHTML = `<span>${u.name}</span><span>Owned: ${u.count}</span>`;
    container.appendChild(div);
  });
}

/* ---------- Achievements rendering + JS tooltip ---------- */
let currentTooltip = null;

function showTooltipForElement(el, text){
  hideTooltip();
  const tip = document.createElement('div');
  tip.className = 'achievement-tooltip';
  tip.textContent = text;
  document.body.appendChild(tip);

  // allow layout then position
  requestAnimationFrame(() => {
    const rect = el.getBoundingClientRect();
    const tipRect = tip.getBoundingClientRect();
    // center horizontally on element
    let left = rect.left + rect.width/2;
    let top = rect.top - tipRect.height - 8;
    // if it would go off top, place below
    if(top < 8) top = rect.bottom + 8;
    // constrain horizontally a bit so it doesn't get fully off-screen
    const margin = 8;
    const minLeft = margin + tipRect.width/2;
    const maxLeft = window.innerWidth - margin - tipRect.width/2;
    if(left < minLeft) left = minLeft;
    if(left > maxLeft) left = maxLeft;

    tip.style.left = left + 'px';
    tip.style.top = top + 'px';
    tip.style.transform = 'translateX(-50%)';
    tip.classList.add('visible');
    currentTooltip = {el, tip};
  });
}

function hideTooltip(){
  if(currentTooltip && currentTooltip.tip){
    currentTooltip.tip.remove();
    currentTooltip = null;
  }
}

function repositionTooltip(){
  if(!currentTooltip) return;
  const el = currentTooltip.el;
  const tip = currentTooltip.tip;
  const rect = el.getBoundingClientRect();
  const tipRect = tip.getBoundingClientRect();
  let left = rect.left + rect.width/2;
  let top = rect.top - tipRect.height - 8;
  if(top < 8) top = rect.bottom + 8;
  const margin = 8;
  const minLeft = margin + tipRect.width/2;
  const maxLeft = window.innerWidth - margin - tipRect.width/2;
  if(left < minLeft) left = minLeft;
  if(left > maxLeft) left = maxLeft;
  tip.style.left = left + 'px';
  tip.style.top = top + 'px';
  tip.style.transform = 'translateX(-50%)';
}

function checkAchievements(){
  const list = document.getElementById('achievementList');
  list.innerHTML = "";

  achievements.forEach(a=>{
    if(a.condition() && !a.earned){
      a.earned = true;
      addLog("Achievement unlocked: " + a.name);
    }

    const li = document.createElement('li');
    li.textContent = a.earned ? "✅ " + a.name : "❌ " + a.name;

    // store tooltip text (requirement + current progress)
    const tooltipText = a.requirement + " (" + a.progress() + ")";
    li.setAttribute('data-tooltip', tooltipText);
    li.setAttribute('title', tooltipText); // native fallback

    // create a small progress bar
    const progressWrap = document.createElement('div');
    progressWrap.className = 'progress';
    const bar = document.createElement('div');
    bar.className = 'progress-bar';
    bar.style.width = a.percent() + '%';
    if(a.earned) bar.style.background = 'green';
    progressWrap.appendChild(bar);
    li.appendChild(progressWrap);
    list.appendChild(li);

    // JS tooltip listeners
    li.addEventListener('mouseenter', () => showTooltipForElement(li, tooltipText));
    li.addEventListener('mouseleave', hideTooltip);
    li.addEventListener('mousemove', repositionTooltip);
  });
}

// reposition tooltip on scroll/resize to keep it anchored
window.addEventListener('scroll', () => { if(currentTooltip) repositionTooltip(); }, true);
window.addEventListener('resize', () => { if(currentTooltip) repositionTooltip(); });

/* ---------- auto-brew and particles ---------- */
setInterval(()=>{
  if(cps > 0){
    coffees += cps;
    updateUI();
    // spawn a few +1 particles
    for(let i=0;i<Math.min(cps,5);i++){
      const offsetX = canvas.width/2 + Math.random()*20 - 10;
      const offsetY = canvas.height/2 + 20 + Math.random()*10 - 5;
      addParticle(offsetX, offsetY, "+1");
    }
  }
}, 1000);

/* ---------- basic controls ---------- */
document.getElementById('resetBtn').onclick = () => {
  if(confirm("Are you sure you want to reset your save?")){
    coffees = 0;
    clickPower = 1;
    cps = 0;
    upgrades.forEach(u => {
      u.count = 0;
      if(u.name === "Auto Brewer") u.cost = 50;
      if(u.name === "Barista") u.cost = 150;
      if(u.name === "Robot Barista") u.cost = 500;
      if(u.name === "New Shop") u.cost = 2000;
    });
    achievements.forEach(a => a.earned = false);
    updateUI();
    renderUpgrades();
    addLog("Game reset!");
  }
};

/* HEX Save/Load helpers */
function stringToHex(str){ return Array.from(str).map(c=>c.charCodeAt(0).toString(16).padStart(2,'0')).join(''); }
function hexToString(hex){ return hex.match(/.{1,2}/g).map(b=>String.fromCharCode(parseInt(b,16))).join(''); }

document.getElementById('saveBtn').onclick = () => {
  const saveData = {
    coffees,
    clickPower,
    upgrades: upgrades.map(u => ({ name: u.name, cost: u.cost, count: u.count })),
    achievements: achievements.map(a => a.earned)
  };
  const saveStr = stringToHex(JSON.stringify(saveData));
  prompt("Copy your save string:", saveStr);
};

document.getElementById('loadBtn').onclick = () => {
  const saveStr = prompt("Paste your save string:");
  if(!saveStr) return;
  try{
    const data = JSON.parse(hexToString(saveStr));
    coffees = data.coffees || 0;
    clickPower = data.clickPower || 1;
    data.upgrades?.forEach(u=>{
      const upgrade = upgrades.find(x => x.name === u.name);
      if(upgrade){ upgrade.cost = u.cost; upgrade.count = u.count; }
    });
    if(data.achievements) data.achievements.forEach((earned,i)=>achievements[i].earned = earned);
    cps = upgrades.reduce((sum, u) => sum + u.count * u.cps, 0);
    updateUI();
    renderUpgrades();
    addLog("Save loaded!");
  } catch(e){
    alert("Invalid save string.");
  }
};

/* ---------- helpers ---------- */
function addLog(msg){ console.log(msg); }

/* ---------- init ---------- */
renderUpgrades();
updateUI();
gameLoop();
</script>
</body>
</html>
